{% extends 'base.html' %}

{% block content %}
<section class="catalog-hero text-center">
    <div class="container">
        <h1 class="catalog-title">–ú–æ—ó –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ</h1>
        <p class="text-sakura-deep opacity-75">–í—Å—ñ –≤–∞—à—ñ –æ—Ü—ñ–Ω–∫–∏ –∑ –∫–æ–º–µ–Ω—Ç–∞—Ä—è–º–∏.</p>
    </div>
</section>

<div class="container py-5">
    {% if comments %}
    <div class="row g-4">
        {% for rating in comments %}
        <div class="col-12 col-md-6">
            <div class="glass-card review-card">
                <div class="review-header">
                    <div>
                        <h6 class="text-sakura-deep mb-1">
                            <a href="{% url 'media_detail' rating.media_item.pk %}" class="text-sakura-deep text-decoration-none">
                                {{ rating.media_item.title }}
                            </a>
                        </h6>
                        <small class="text-sakura-rose">{{ rating.created_at|date:"d.m.Y" }}</small>
                    </div>
                    <div class="review-score d-inline-flex align-items-center flex-wrap gap-2">
                        <div class="star-rating-detailed" data-rating="{{ rating.score }}">
                            <span class="star">‚òÖ</span>
                            <span class="star">‚òÖ</span>
                            <span class="star">‚òÖ</span>
                            <span class="star">‚òÖ</span>
                            <span class="star">‚òÖ</span>
                        </div>
                        <span class="text-sakura-deep fw-bold">{{ rating.score }}/10</span>
                    </div>
                </div>
                <p class="text-sakura-deep mb-0 rating-comment">{{ rating.comment }}</p>
                <div class="d-flex flex-wrap gap-2 mt-3">
                    <button
                        type="button"
                        class="btn btn-sakura-ghost btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#editRatingModal"
                        data-rating-id="{{ rating.id }}"
                        data-score="{{ rating.score }}"
                        data-comment="{{ rating.comment|default_if_none:''|escapejs }}"
                        data-media-title="{{ rating.media_item.title|escapejs }}"
                    >
                        –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
                    </button>
                    <form method="POST" action="{% url 'delete_rating' rating.id %}" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <button type="submit" class="btn btn-sakura-ghost btn-sm">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <div class="display-1 text-sakura-soft mb-3">üôÇ</div>
        <h4 class="text-sakura-deep mb-2">–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î</h4>
        <p class="text-sakura-deep opacity-75 mb-3">–î–æ–¥–∞–π—Ç–µ –æ—Ü—ñ–Ω–∫—É –∑ –∫–æ–º–µ–Ω—Ç–∞—Ä–µ–º –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –≤–ø–æ–¥–æ–±–∞–Ω–æ–≥–æ —Ç–∞–π—Ç–ª—É.</p>
        <a href="{% url 'media_list' %}" class="btn btn-sakura-primary">–î–æ –∫–∞—Ç–∞–ª–æ–≥—É</a>
    </div>
    {% endif %}
</div>
<div class="modal fade modal-sakura" id="editRatingModal" tabindex="-1" data-update-url-template="{% url 'update_rating' 0 %}">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-sakura-deep" id="editRatingTitle">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –≤—ñ–¥–≥—É–∫</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% url 'update_rating' 0 %}" id="editRatingForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-sakura-deep mb-2">–û—Ü—ñ–Ω–∫–∞ (1-10)</label>
                        <input type="number" name="score" id="editScoreInput" class="form-control input-sakura" min="1" max="10" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-sakura-deep mb-2">–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
                        <textarea name="comment" id="editCommentInput" class="form-control input-sakura" rows="4" placeholder="–û–Ω–æ–≤—ñ—Ç—å —Å–≤—ñ–π –≤—ñ–¥–≥—É–∫..."></textarea>
                    </div>
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sakura-ghost" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button type="submit" class="btn btn-sakura-primary">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/star_ratingv2.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const editModal = document.getElementById('editRatingModal');
        if (!editModal) return;

        const editForm = document.getElementById('editRatingForm');
        const editScoreInput = document.getElementById('editScoreInput');
        const editCommentInput = document.getElementById('editCommentInput');
        const editTitle = document.getElementById('editRatingTitle');
        const updateUrlTemplate = editModal.dataset.updateUrlTemplate;

        editModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            if (!button) return;

            const ratingId = button.getAttribute('data-rating-id');
            const score = button.getAttribute('data-score') || '';
            const comment = button.getAttribute('data-comment') || '';
            const mediaTitle = button.getAttribute('data-media-title') || '';

            if (editForm && updateUrlTemplate && ratingId) {
                editForm.action = updateUrlTemplate.replace('0', ratingId);
            }

            if (editScoreInput) {
                editScoreInput.value = score;
            }

            if (editCommentInput) {
                editCommentInput.value = comment;
            }

            if (editTitle) {
                editTitle.textContent = mediaTitle
                    ? `–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –≤—ñ–¥–≥—É–∫ –ø—Ä–æ \"${mediaTitle}\"`
                    : '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –≤—ñ–¥–≥—É–∫';
            }
        });
    });
</script>
{% endblock %}
